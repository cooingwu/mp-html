<!-- 解读弹窗组件模板
  支持富文本、视频、音频三种内容类型
  PC端：直接显示当前页，通过分页控制切换
  移动端：使用 swiper 滑动翻页 -->
<wxs module="utils" src="./utils.wxs"></wxs>
<!-- 页面内容模板 -->
<template name="pageContent">
  <!-- 富文本类型 -->
  <block wx:if="{{item.type === 'richtext'}}">
    <view wx:if="{{item.title}}" class="page-title">{{item.title}}</view>
    <view class="richtext-body">
      <image wx:if="{{item.image}}" class="page-image" src="{{item.image}}" mode="widthFix" data-src="{{item.image}}" bindtap="onImageTap" />
      <text wx:if="{{item.content}}" class="page-text">{{item.content}}</text>
    </view>
  </block>
  <!-- 视频类型 -->
  <block wx:elif="{{item.type === 'video'}}">
    <video wx:if="{{item.video}}" class="page-video" src="{{item.video}}" poster="{{item.videoCover}}" controls="{{true}}" show-center-play-btn="{{true}}" object-fit="contain" bindplay="onVideoPlay" />
  </block>
  <!-- 音频类型 -->
  <block wx:elif="{{item.type === 'audio'}}">
    <view class="audio-container">
      <image wx:if="{{item.audioCover}}" class="audio-cover" src="{{item.audioCover}}" mode="aspectFill" />
      <view wx:else class="audio-cover-placeholder">
        <text class="audio-icon">♫</text>
      </view>
      <view class="audio-info">
        <view class="audio-title">{{item.audioTitle || '音频'}}</view>
        <view class="audio-controls">
          <view class="play-btn" bindtap="toggleAudio" data-index="{{index}}">
            <text class="play-icon">{{isCurrentPlaying ? '⏸' : '▶'}}</text>
          </view>
          <view class="audio-progress">
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{progressPercent}}%"></view>
            </view>
            <view class="time-display">
              <view>{{currentTimeStr}} / {{durationStr}}</view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </block>
  <!-- 空状态 -->
  <view class="empty-state" wx:else>
    <text>暂无内容</text>
  </view>
</template>
<view class="tooltip-container {{mode}} {{isPc ? 'is-pc' : 'is-mobile'}}" catchtap="stopPropagation">
  <!-- 关闭按钮 -->
  <view class="close-btn" wx:if="{{showClose}}" bindtap="onClose">×</view>
  <!-- ==================== 移动端：使用 swiper ==================== -->
  <swiper wx:if="{{!isPc}}" class="tooltip-swiper" style="{{swiperHeight > 0 ? 'height: ' + swiperHeight + 'px;' : ''}}" bindchange="onSwiperChange" indicator-dots="{{pages.length > 1}}" indicator-color="rgba(0, 0, 0, 0.3)" indicator-active-color="#ff4d4f">
    <swiper-item wx:for="{{pages}}" wx:key="id" class="swiper-page">
      <scroll-view scroll-y class="page-scroll" style="{{swiperHeight > 0 ? 'height: ' + swiperHeight + 'px;' : ''}}">
        <template is="pageContent" data="{{item: item, index: index, isCurrentPlaying: index === currentIndex && isPlaying, progressPercent: index === currentIndex && audioDuration > 0 ? (audioCurrentTime / audioDuration * 100) : 0, currentTimeStr: index === currentIndex ? utils.formatTime(audioCurrentTime) : '00:00', durationStr: index === currentIndex ? utils.formatTime(audioDuration) : '00:00'}}" />
      </scroll-view>
    </swiper-item>
  </swiper>
  <!-- ==================== PC端：直接显示当前页 ==================== -->
  <scroll-view wx:if="{{isPc && pages.length > 0}}" scroll-y class="page-scroll pc-scroll" style="{{swiperHeight > 0 ? 'height: ' + swiperHeight + 'px;' : ''}}">
    <template is="pageContent" data="{{item: pages[currentIndex], index: currentIndex, isCurrentPlaying: isPlaying, progressPercent: audioDuration > 0 ? (audioCurrentTime / audioDuration * 100) : 0, currentTimeStr: utils.formatTime(audioCurrentTime), durationStr: utils.formatTime(audioDuration)}}" />
  </scroll-view>
  <!-- 空页面状态 -->
  <view class="empty-state" wx:if="{{pages.length === 0}}">
    <text>暂无内容</text>
  </view>
  <!-- 分页控制 - 只在 PC 端多页时显示 -->
  <view wx:if="{{isPc && pages.length > 1}}" class="pagination">
    <view class="page-btn {{currentIndex === 0 ? 'disabled' : ''}}" bindtap="prevPage">
      <text class="btn-icon">‹</text>
    </view>
    <view class="page-dots">
      <view wx:for="{{pages}}" wx:key="id" class="dot {{index === currentIndex ? 'active' : ''}}" bindtap="goToPage" data-index="{{index}}"></view>
    </view>
    <view class="page-btn {{currentIndex === pages.length - 1 ? 'disabled' : ''}}" bindtap="nextPage">
      <text class="btn-icon">›</text>
    </view>
  </view>
</view>