"use strict";function t(e){"@babel/helpers - typeof";return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,i)}return o}function o(t){for(var o=1;o<arguments.length;o++){var n=null!=arguments[o]?arguments[o]:{};o%2?e(Object(n),!0).forEach(function(e){i(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):e(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function i(t,e,o){return(e=n(e))in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}function n(e){var o=r(e,"string");return"symbol"==t(o)?o:o+""}function r(e,o){if("object"!=t(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,o||"default");if("object"!=t(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===o?String:Number)(e)}var a=require("./utils");Component({options:{addGlobalClass:!0},properties:{node:{type:Object,value:{}},opts:{type:Array,value:[]}},data:{imageLoaded:!1,imageWidth:0,imageHeight:0,anchors:[],styles:[],mode:"container",animation:!0,activeAnchor:null,tooltipPosition:"bottom",anchorY:50,anchorSizePercent:8,tooltipOffset:4,tooltipVisible:!1,tooltipClosing:!1,showModal:!1,modalClosing:!1,showMask:!1,isPc:!1,isSkyline:!1,isVideoFullscreen:!1},lifetimes:{attached:function(){this.setData({isPc:(0,a.checkIsPc)(),isSkyline:(0,a.checkIsSkyline)()}),this.initFromRoot()}},pageLifetimes:{resize:function(){this.initImageDimensions()}},methods:{initFromRoot:function(){var t=this.data.node,e=[],o=[],i="container",n=!0;t.anchorData&&(e=t.anchorData.anchors||[],o=t.anchorData.styles||[],i=t.anchorData.tooltipMode||"container",n=!1!==t.anchorData.showAnimation),this.setData({anchors:e,styles:o,mode:i,animation:n})},onImageLoad:function(t){var e=t.detail,o=e.width,i=e.height;console.log("[image-anchor] 图片加载完成，原始尺寸：",o,i),this.initImageDimensions(),this.triggerEvent("imgload",t.detail)},initImageDimensions:function(){var t=this;this.createSelectorQuery().select(".anchor-image").boundingClientRect(function(e){e&&(t.setData({imageLoaded:!0,imageWidth:e.width,imageHeight:e.height}),console.log("[image-anchor] 图片实际显示尺寸：",e.width,e.height))}).exec()},onImageError:function(t){this.triggerEvent("imgerror",t.detail)},onImageTap:function(t){if(!(t.target&&t.target.dataset&&t.target.dataset.anchor)){var e=this.data.node;this.triggerEvent("imgtap",e.attrs)}},onAnchorTap:function(t){var e,o=this,i=t.detail||{},n=i.anchor;if(n){this.setData({activeAnchor:null,tooltipVisible:!1});var r=this.data.mode,a=n.position||{x:50,y:50},s=a.y>=50?"top":"bottom",c=a.y,l=(null===(e=n.style)||void 0===e?void 0:e.size)||8,h=this.data,g=h.imageWidth,u=h.imageHeight,p=l/2;if(g&&u){p=l*(g/u)/2}this.setData({activeAnchor:n,tooltipPosition:s,anchorY:c,anchorSizePercent:l,tooltipOffset:p,tooltipClosing:!1,showModal:"modal"===r,showMask:"container"===r}),"container"===r&&setTimeout(function(){o.setData({tooltipVisible:!0})},20),this.triggerEvent("anchortap",{anchor:n}),this.triggerEvent("tooltipshow",{anchor:n})}},onTooltipClose:function(){var t=this,e=this.data,o=e.activeAnchor;"container"===e.mode?(this.setData({tooltipClosing:!0}),setTimeout(function(){t.setData({activeAnchor:null,tooltipVisible:!1,tooltipClosing:!1,showMask:!1}),t.triggerEvent("tooltiphide",{anchor:o})},300)):(this.setData({modalClosing:!0}),setTimeout(function(){t.setData({activeAnchor:null,showModal:!1,modalClosing:!1,showMask:!1,tooltipVisible:!1}),t.triggerEvent("tooltiphide",{anchor:o})},300))},onPageChange:function(t){this.triggerEvent("pagechange",o(o({},t.detail),{},{anchor:this.data.activeAnchor}))},onVideoFullscreenChange:function(t){var e=t.detail.fullScreen;console.log("[image-anchor] 视频全屏状态变化:",e),this.setData({isVideoFullscreen:e})},onMaskTap:function(){this.onTooltipClose()},onContainerMaskTap:function(){this.onTooltipClose()},onTooltipImgTap:function(t){var e=t.detail||{},o=e.src;if(o){var i=this.getRoot();if(!i)return void wx.previewImage({urls:[o],current:o});if(i.triggerEvent("imgtap",{src:o}),i.data.previewImg){var n=i.imgList||[o];wx.previewImage({showmenu:i.data.showImgMenu,current:o,urls:n.includes(o)?n:[o]})}}},getRoot:function(){for(var t=this.selectOwnerComponent();t;){if(void 0!==t.imgList)return t;t=t.selectOwnerComponent?t.selectOwnerComponent():null}return null},stopPropagation:function(){}}});