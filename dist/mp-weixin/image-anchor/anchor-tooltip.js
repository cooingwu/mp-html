"use strict";Component({properties:{anchor:{type:Object,value:null},position:{type:String,value:"bottom"},mode:{type:String,value:"container"},showClose:{type:Boolean,value:!0},isPc:{type:Boolean,value:!1}},data:{pages:[],currentIndex:0,swiperHeight:0,isPlaying:!1,audioDuration:0,audioCurrentTime:0},observers:{anchor:function(t){var e=this;t&&t.tooltipPages?this.setData({pages:t.tooltipPages,currentIndex:0,swiperHeight:0},function(){e.calculateSwiperHeight()}):this.setData({pages:[],currentIndex:0,swiperHeight:0})}},lifetimes:{detached:function(){this.destroyAudio()}},methods:{calculateSwiperHeight:function(){var t=this,e=this.data,i=e.mode,o=e.isPc,a=e.pages,n=e.currentIndex;if(console.log("[calculateSwiperHeight] 开始计算",{mode:i,isPc:o,pagesLength:a.length,currentIndex:n}),!a||0===a.length)return void console.log("[calculateSwiperHeight] 空页面，跳过计算");var r="video"===a[n].type;console.log("[calculateSwiperHeight] 是否包含视频:",r),setTimeout(function(){var e=wx.getWindowInfo(),u=e.windowHeight,s=e.windowWidth,c=o&&a.length>1?40:0;if(console.log("[calculateSwiperHeight] 屏幕信息",{screenHeight:u,screenWidth:s,paginationHeight:c}),"container"===i){var l=t.createSelectorQuery();l.select(".tooltip-container").boundingClientRect(),l.exec(function(e){var i,o=(null===(i=e[0])||void 0===i?void 0:i.height)||0,a=o-c;console.log("[calculateSwiperHeight] container模式",{containerHeight:o,paginationHeight:c,swiperHeight:a}),a>0&&a!==t.data.swiperHeight&&(console.log("[calculateSwiperHeight] 设置 swiperHeight:",a),t.setData({swiperHeight:a}))})}else{var g=.7*u,d=.2*u;if(console.log("[calculateSwiperHeight] modal模式",{maxHeight:g,minHeight:d}),r){var h=s-24,p=.75*(h-32),w=p+32;return console.log("[calculateSwiperHeight] 视频高度计算",{containerWidth:h,videoHeight:p,swiperHeight:w}),w=Math.min(w,g-c),console.log("[calculateSwiperHeight] 应用max约束后:",w),void(w>0&&w!==t.data.swiperHeight&&(console.log("[calculateSwiperHeight] 设置视频 swiperHeight:",w),t.setData({swiperHeight:w})))}var H=t.createSelectorQuery();H.selectAll(".content-edge-"+n).boundingClientRect(),H.exec(function(e){var i=e[0]||[];console.log("[calculateSwiperHeight] 查询 .content-edge 结果:",i);var o=0;i.forEach(function(t,e){console.log("[calculateSwiperHeight] 第".concat(e,"页内容高度:"),null===t||void 0===t?void 0:t.height),t&&t.height>o&&(o=t.height)}),o<=0&&(o=150,console.log("[calculateSwiperHeight] 内容高度为0，使用默认值:",o));var a=o;console.log("[calculateSwiperHeight] 初始 swiperHeight:",a),a=Math.max(a,d-c),a=Math.min(a,g-c),console.log("[calculateSwiperHeight] 应用min/max约束后:",a),a>0&&a!==t.data.swiperHeight?(console.log("[calculateSwiperHeight] 设置 swiperHeight:",a),t.setData({swiperHeight:a})):console.log("[calculateSwiperHeight] 高度未变化，跳过设置",{swiperHeight:a,current:t.data.swiperHeight})})}},100)},onClose:function(){this.destroyAudio(),this.triggerEvent("close")},prevPage:function(){var t=this.data.currentIndex;t>0&&this.goToPage(t-1)},nextPage:function(){var t=this.data,e=t.currentIndex;e<t.pages.length-1&&this.goToPage(e+1)},goToPage:function(t){var e,i=this;e="number"==typeof t?t:t.currentTarget.dataset.index;var o=this.data,a=o.pages,n=o.currentIndex;e>=0&&e<a.length&&e!==n&&(this.destroyAudio(),this.setData({currentIndex:e},function(){i.calculateSwiperHeight()}),this.triggerEvent("pagechange",{index:e,page:a[e]}))},onSwiperChange:function(t){var e=this,i=t.detail,o=i.current,a=i.source,n=this.data,r=n.pages,u=n.currentIndex;"touch"===a&&o!==u&&o>=0&&o<r.length&&(this.destroyAudio(),this.setData({currentIndex:o},function(){e.calculateSwiperHeight()}),this.triggerEvent("pagechange",{index:o,page:r[o]}))},onImageTap:function(t){var e=t.currentTarget.dataset.src;e&&this.triggerEvent("imgtap",{src:e})},onVideoPlay:function(){},audioContext:null,initAudio:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=this.data,o=i.pages,a=i.currentIndex,n=o[a];if(n&&"audio"===n.type&&n.audio){this.destroyAudio();var r=wx.createInnerAudioContext();r.src=n.audio,r.onCanplay(function(){console.log("[initAudio] 音频准备就绪, duration:",r.duration),t.setData({audioDuration:r.duration}),e&&r.play()}),r.onTimeUpdate(function(){var e={audioCurrentTime:r.currentTime};r.duration>0&&t.data.audioDuration!==r.duration&&(e.audioDuration=r.duration),t.setData(e)}),r.onPlay(function(){console.log("[initAudio] 开始播放, duration:",r.duration);var e={isPlaying:!0};r.duration>0&&t.data.audioDuration!==r.duration&&(e.audioDuration=r.duration),t.setData(e)}),r.onPause(function(){console.log("[initAudio] 暂停"),t.setData({isPlaying:!1})}),r.onEnded(function(){console.log("[initAudio] 播放结束"),t.setData({isPlaying:!1,audioCurrentTime:0})}),r.onError(function(e){console.error("[initAudio] 音频播放错误",e),t.setData({isPlaying:!1})}),this.audioContext=r}},toggleAudio:function(){if(console.log("[toggleAudio] 点击, isPlaying:",this.data.isPlaying,"audioContext:",!!this.audioContext),!this.audioContext)return void this.initAudio(!0);this.data.isPlaying?this.audioContext.pause():this.audioContext.play()},destroyAudio:function(){this.audioContext&&(this.audioContext.stop(),this.audioContext.destroy(),this.audioContext=null,this.setData({isPlaying:!1,audioCurrentTime:0,audioDuration:0}))},stopPropagation:function(){}}});