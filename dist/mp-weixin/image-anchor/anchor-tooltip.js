"use strict";var t=require("./utils");Component({properties:{anchor:{type:Object,value:null},position:{type:String,value:"bottom"},mode:{type:String,value:"container"},showClose:{type:Boolean,value:!0}},data:{pages:[],currentIndex:0,swiperHeight:0,isPlaying:!1,audioDuration:0,audioCurrentTime:0,isPc:!1,isSkyline:!1},observers:{anchor:function(t){var e=this;t&&t.tooltipPages?this.setData({pages:t.tooltipPages,currentIndex:0,swiperHeight:0},function(){e.calculateSwiperHeight()}):this.setData({pages:[],currentIndex:0,swiperHeight:0})}},lifetimes:{attached:function(){this.setData({isPc:(0,t.checkIsPc)(),isSkyline:(0,t.checkIsSkyline)()})},detached:function(){this.destroyAudio()}},pageLifetimes:{resize:function(){this.calculateSwiperHeight()}},methods:{calculateSwiperHeight:function(){var t=this,e=this.data,i=e.mode,n=e.isPc,o=e.pages,a=e.currentIndex;if(console.log("[calculateSwiperHeight] 开始计算",{mode:i,isPc:n,pagesLength:o.length,currentIndex:a}),!o||0===o.length)return void console.log("[calculateSwiperHeight] 空页面，跳过计算");var r="video"===o[a].type;console.log("[calculateSwiperHeight] 是否包含视频:",r),setTimeout(function(){var e=wx.getWindowInfo(),a=e.windowHeight,r=e.windowWidth,u=n&&o.length>1?40:0;if(console.log("[calculateSwiperHeight] 屏幕信息",{screenHeight:a,screenWidth:r,paginationHeight:u}),"container"!==i){var s=.4*a;return console.log("[calculateSwiperHeight] modal模式",{height:s}),void t.setData({swiperHeight:s})}var c=t.createSelectorQuery();c.select(".tooltip-container").boundingClientRect(),c.exec(function(e){var i,n=(null===(i=e[0])||void 0===i?void 0:i.height)||0,o=n-u;console.log("[calculateSwiperHeight] container模式",{containerHeight:n,paginationHeight:u,swiperHeight:o}),o>0&&o!==t.data.swiperHeight&&(console.log("[calculateSwiperHeight] 设置 swiperHeight:",o),t.setData({swiperHeight:o}))})},100)},onClose:function(){this.destroyAudio(),this.triggerEvent("close")},prevPage:function(){var t=this.data.currentIndex;t>0&&this.goToPage(t-1)},nextPage:function(){var t=this.data,e=t.currentIndex;e<t.pages.length-1&&this.goToPage(e+1)},goToPage:function(t){var e,i=this;e="number"==typeof t?t:t.currentTarget.dataset.index;var n=this.data,o=n.pages,a=n.currentIndex;e>=0&&e<o.length&&e!==a&&(this.destroyAudio(),this.setData({currentIndex:e},function(){i.calculateSwiperHeight()}),this.triggerEvent("pagechange",{index:e,page:o[e]}))},onSwiperChange:function(t){var e=this,i=t.detail,n=i.current,o=i.source,a=this.data,r=a.pages,u=a.currentIndex;"touch"===o&&n!==u&&n>=0&&n<r.length&&(this.destroyAudio(),this.setData({currentIndex:n},function(){e.calculateSwiperHeight()}),this.triggerEvent("pagechange",{index:n,page:r[n]}))},onImageTap:function(t){var e=t.currentTarget.dataset.src;e&&this.triggerEvent("imgtap",{src:e})},onVideoPlay:function(){},onVideoFullscreenChange:function(t){var e=t.detail.fullScreen;console.log("[onVideoFullscreenChange] 全屏状态变化:",e),this.triggerEvent("videofullscreenchange",{fullScreen:e})},audioContext:null,initAudio:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=this.data,n=i.pages,o=i.currentIndex,a=n[o];if(a&&"audio"===a.type&&a.audio){this.destroyAudio();var r=wx.createInnerAudioContext();r.src=a.audio,r.onCanplay(function(){console.log("[initAudio] 音频准备就绪, duration:",r.duration),t.setData({audioDuration:r.duration}),e&&r.play()}),r.onTimeUpdate(function(){var e={audioCurrentTime:r.currentTime};r.duration>0&&t.data.audioDuration!==r.duration&&(e.audioDuration=r.duration),t.setData(e)}),r.onPlay(function(){console.log("[initAudio] 开始播放, duration:",r.duration);var e={isPlaying:!0};r.duration>0&&t.data.audioDuration!==r.duration&&(e.audioDuration=r.duration),t.setData(e)}),r.onPause(function(){console.log("[initAudio] 暂停"),t.setData({isPlaying:!1})}),r.onEnded(function(){console.log("[initAudio] 播放结束"),t.setData({isPlaying:!1,audioCurrentTime:0})}),r.onError(function(e){console.error("[initAudio] 音频播放错误",e),t.setData({isPlaying:!1})}),this.audioContext=r}},toggleAudio:function(){if(console.log("[toggleAudio] 点击, isPlaying:",this.data.isPlaying,"audioContext:",!!this.audioContext),!this.audioContext)return void this.initAudio(!0);this.data.isPlaying?this.audioContext.pause():this.audioContext.play()},destroyAudio:function(){this.audioContext&&(this.audioContext.stop(),this.audioContext.destroy(),this.audioContext=null,this.setData({isPlaying:!1,audioCurrentTime:0,audioDuration:0}))},stopPropagation:function(){}}});