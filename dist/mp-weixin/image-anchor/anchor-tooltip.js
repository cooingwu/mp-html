"use strict";function t(){function n(t,n,o,i){var a=n&&n.prototype instanceof r?n:r,s=Object.create(a.prototype);return e(s,"_invoke",function(t,e,n){function r(t,e){for(i=t,a=e,c=0;!d&&s&&!n&&c<f.length;c++){var n,r=f[c],o=p.p,g=r[2];t>3?(n=g===e)&&(a=r[(i=r[4])?5:(i=3,3)],r[4]=r[5]=u):r[0]<=o&&((n=t<2&&o<r[1])?(i=0,p.v=e,p.n=r[1]):o<g&&(n=t<3||r[0]>e||e>g)&&(r[4]=t,r[5]=e,p.n=g,i=0))}if(n||t>1)return l;throw d=!0,e}var o,i,a,s=0,f=n||[],d=!1,p={p:0,n:0,v:u,a:r,f:r.bind(u,4),d:function(t,e){return o=t,i=0,a=u,p.n=e,l}};return function(n,f,g){if(s>1)throw TypeError("Generator is already running");for(d&&1===f&&r(f,g),i=f,a=g;(c=i<2?u:a)||!d;){o||(i?i<3?(i>1&&(p.n=-1),r(i,a)):p.n=a:p.v=a);try{if(s=2,o){if(i||(n="next"),c=o[n]){if(!(c=c.call(o,a)))throw TypeError("iterator result is not an object");if(!c.done)return c;a=c.value,i<2&&(i=0)}else 1===i&&(c=o.return)&&c.call(o),i<2&&(a=TypeError("The iterator does not provide a '"+n+"' method"),i=1);o=u}else if((c=(d=p.n<0)?a:t.call(e,p))!==l)break}catch(t){o=u,i=1,a=t}finally{s=1}}return{value:c,done:d}}}(t,o,i),!0),s}function r(){}function o(){}function i(){}function a(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,i):(t.__proto__=i,e(t,d,"GeneratorFunction")),t.prototype=Object.create(g),t}/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var u,c,s="function"==typeof Symbol?Symbol:{},f=s.iterator||"@@iterator",d=s.toStringTag||"@@toStringTag",l={};c=Object.getPrototypeOf;var p=[][f]?c(c([][f]())):(e(c={},f,function(){return this}),c),g=i.prototype=r.prototype=Object.create(p);return o.prototype=i,e(g,"constructor",i),e(i,"constructor",o),o.displayName="GeneratorFunction",e(i,d,"GeneratorFunction"),e(g),e(g,d,"Generator"),e(g,f,function(){return this}),e(g,"toString",function(){return"[object Generator]"}),(t=function(){return{w:n,m:a}})()}function e(t,n,r,o){var i=Object.defineProperty;try{i({},"",{})}catch(t){i=0}(e=function(t,n,r,o){function a(n,r){e(t,n,function(t){return this._invoke(n,r,t)})}n?i?i(t,n,{value:r,enumerable:!o,configurable:!o,writable:!o}):t[n]=r:(a("next",0),a("throw",1),a("return",2))})(t,n,r,o)}function n(t,e,n,r,o,i,a){try{var u=t[i](a),c=u.value}catch(t){return void n(t)}u.done?e(c):Promise.resolve(c).then(r,o)}function r(t){return function(){var e=this,r=arguments;return new Promise(function(o,i){function a(t){n(c,o,i,a,u,"next",t)}function u(t){n(c,o,i,a,u,"throw",t)}var c=t.apply(e,r);a(void 0)})}}Component({properties:{anchor:{type:Object,value:null},position:{type:String,value:"bottom"},mode:{type:String,value:"container"}},data:{pages:[],currentIndex:0,currentPage:null,audioContext:null,isPlaying:!1,audioDuration:0,audioCurrentTime:0},observers:{anchor:function(t){var e=this;t&&t.tooltipPages?this.convertCloudUrls(t.tooltipPages).then(function(t){e.setData({pages:t,currentIndex:0,currentPage:t[0]||null})}):this.setData({pages:[],currentIndex:0,currentPage:null})}},lifetimes:{detached:function(){this.destroyAudio()}},methods:{isCloudUrl:function(t){return t&&"string"==typeof t&&t.startsWith("cloud://")},convertCloudUrls:function(e){var n=this;return r(t().m(function r(){var o,i,a,u,c;return t().w(function(t){for(;;)switch(t.p=t.n){case 0:if(e&&e.length){t.n=1;break}return t.a(2,e);case 1:if(o=[],i={},e.forEach(function(t,e){["image","videoCover","video","audioCover","audio"].forEach(function(r){n.isCloudUrl(t[r])&&(o.push({fileID:t[r],maxAge:7200}),i[t[r]]={pageIndex:e,field:r})})}),o.length){t.n=2;break}return t.a(2,e);case 2:return t.p=2,t.n=3,wx.cloud.getTempFileURL({fileList:o.map(function(t){return t.fileID})});case 3:return a=t.v,u=JSON.parse(JSON.stringify(e)),a.fileList&&a.fileList.forEach(function(t){if(t.tempFileURL&&i[t.fileID]){var e=i[t.fileID],n=e.pageIndex,r=e.field;u[n][r]=t.tempFileURL}}),t.a(2,u);case 4:return t.p=4,c=t.v,console.error("转换云存储链接失败",c),t.a(2,e)}},r,null,[[2,4]])}))()},onClose:function(){this.destroyAudio(),this.triggerEvent("close")},prevPage:function(){var t=this.data,e=t.currentIndex;t.pages;e>0&&this.goToPage(e-1)},nextPage:function(){var t=this.data.currentIndex;t<this.data.pages.length-1&&this.goToPage(t+1)},goToPage:function(t){var e;e="number"==typeof t?t:t.currentTarget.dataset.index;var n=this.data,r=n.pages,o=n.currentIndex;e>=0&&e<r.length&&e!==o&&(this.destroyAudio(),this.setData({currentIndex:e,currentPage:r[e]}),this.triggerEvent("pagechange",{index:e,page:r[e]}))},onImageTap:function(t){var e=t.currentTarget.dataset.src;e&&wx.previewImage({urls:[e],current:e})},onVideoPlay:function(){},initAudio:function(){var t=this,e=this.data.currentPage;if(e&&"audio"===e.type&&e.audio){this.destroyAudio();var n=wx.createInnerAudioContext();n.src=e.audio,n.onCanplay(function(){t.setData({audioDuration:n.duration})}),n.onTimeUpdate(function(){t.setData({audioCurrentTime:n.currentTime})}),n.onPlay(function(){t.setData({isPlaying:!0})}),n.onPause(function(){t.setData({isPlaying:!1})}),n.onEnded(function(){t.setData({isPlaying:!1,audioCurrentTime:0})}),n.onError(function(e){console.error("音频播放错误",e),t.setData({isPlaying:!1})}),this.audioContext=n}},toggleAudio:function(){this.audioContext||this.initAudio(),this.data.isPlaying?this.audioContext.pause():this.audioContext.play()},destroyAudio:function(){this.audioContext&&(this.audioContext.stop(),this.audioContext.destroy(),this.audioContext=null,this.setData({isPlaying:!1,audioCurrentTime:0,audioDuration:0}))},formatTime:function(t){var e=Math.floor(t/60),n=Math.floor(t%60);return"".concat(e.toString().padStart(2,"0"),":").concat(n.toString().padStart(2,"0"))},stopPropagation:function(){}}});